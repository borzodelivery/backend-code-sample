
# Borzo Backend Code Sample

–î–∞–≤–∞–π—Ç–µ –ø–æ —à–∞–≥–∞–º —Ä–∞–∑–±–µ—Ä—ë–º –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–¥–∞—á–µ, –∫–∞–∫ –º—ã —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ —Ñ–∏—á–∏ –≤ –ë–æ—Ä–∑–æ (aka –î–æ—Å—Ç–∞–≤–∏—Å—Ç–µ).

–ö–æ–¥ –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ —Ä–∞–¥–∏ –ø—Ä–∏–º–µ—Ä–∞, –µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å, –Ω–æ –µ–≥–æ –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å.

**–î–∞, –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫ –Ω–∞–º! –£ –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.**
<br>üî• [–ù–∞—à–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–∞ HeadHunter](https://hh.ru/employer/3730831).


## –ó–∞–¥–∞—á–∞

–í –∫—É—Ä—å–µ—Ä—Å–∫–æ–º –º–æ–±–∏–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫—É—Ä—å–µ—Ä–∞.

–ö–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å: –∫—É—Ä—å–µ—Ä –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∑–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –≤–∏–¥–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.

![](.github/task.png)

1. –¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å–ª—É—á–∞–π–Ω—ã–π.<br>
   –ü—Ä–∏–º–µ—Ä—ã: ¬´–ü—Ä–∏–≤–µ—Ç, –ò–≥–æ—Ä—å¬ª, ¬´–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –ê–Ω–¥—Ä–µ–π!¬ª, ¬´–ë—É—ç–Ω–æ—Å –¥–∏–∞—Å, –∞–º–∏–≥–æ!¬ª.
2. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (¬´–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ¬ª, ¬´–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä¬ª) –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä–µ–º–µ–Ω–∏.<br>
   –ù–∞–ø—Ä–∏–º–µ—Ä, ¬´–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ¬ª –ø–∏—à–µ–º —Ç–æ–ª—å–∫–æ —Å 5:00 –¥–æ 10:00.
3. –°–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∏ –≤—Ä–µ–º—è –¥–ª—è –∏—Ö –ø–æ–∫–∞–∑–∞ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ.


## –ú–∏–≥—Ä–∞—Ü–∏–∏

–ß—Ç–æ–±—ã —Ö—Ä–∞–Ω–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π, —Å–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É `courier_greetings` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
<br>–î–ª—è —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ [migrations](https://github.com/27cm/backend-code-sample/tree/master/migrations). 

**[migrations/2021-10-30_12-01_create_table_courier_greetings.php](https://github.com/27cm/backend-code-sample/blob/master/migrations/2021-10-30_12-01_create_table_courier_greetings.php)**

```php
<?php

use Dostavista\Framework\Database\Migrations\CreateTableMysqlMigrationAbstract;

return new class() extends CreateTableMysqlMigrationAbstract {
    protected function getCreateTableSql(): string {
        return "
            CREATE TABLE courier_greetings (
                courier_greeting_id INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT COMMENT '–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∫—É—Ä—å–µ—Ä–∞',
                greeting_template VARCHAR(1024) NOT NULL COMMENT '–®–∞–±–ª–æ–Ω —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
                allowed_to_show_start_time TIME NOT NULL DEFAULT '00:00:00' COMMENT '–î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
                allowed_to_show_finish_time TIME NOT NULL DEFAULT '23:59:59' COMMENT '–î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
                is_deleted TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '–£–¥–∞–ª–µ–Ω–∞ –ª–∏ –∑–∞–ø–∏—Å—å',
                INDEX idx_allowed_to_show_time (allowed_to_show_start_time, allowed_to_show_finish_time)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='–õ–∏—á–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∫—É—Ä—å–µ—Ä–æ–≤ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö';
        ";
    }
};
```

–í –æ—Ç–¥–µ–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞–ø–æ–ª–Ω–∏–º –Ω–∞—à—É —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏.

**[migrations/2021-10-30_12-02_insert_courier_greetings_data.php](https://github.com/27cm/backend-code-sample/blob/master/migrations/2021-10-30_12-02_insert_courier_greetings_data.php)**

```php
<?php

use Dostavista\Core\Super;
use Dostavista\Framework\Database\Migrations\MysqlMigrationAbstract;

return new class() extends MysqlMigrationAbstract {
    /**
     * @return string[]
     */
    public function getChangedTables(): array {
        return ['courier_greetings'];
    }

    protected function execute(): void {
        if (Super::getConfig()->isRussia()) {
            Super::getDb()->query("
                INSERT INTO courier_greetings
                    (greeting_template, allowed_to_show_start_time, allowed_to_show_finish_time)
                VALUES 
                    ('–ü—Ä–∏–≤–µ—Ç, %name%!', '00:00:00', '23:59:59'),
                    ('–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!', '00:00:00', '23:59:59'),
                    ('–î–æ–±—Ä–æ–π –Ω–æ—á–∏, %name%!', '00:00:00', '04:59:59'),
                    ('–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, %name%!', '05:00:00', '09:59:59'),
                    ('–î–æ–±—Ä—ã–π –¥–µ–Ω—å, %name%!', '10:00:00', '17:59:59'),
                    ('–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä, %name%!', '18:00:00', '23:59:59')
            ");
        } else {
            Super::getDb()->query("
                INSERT INTO courier_greetings
                    (greeting_template, allowed_to_show_start_time, allowed_to_show_finish_time)
                VALUES 
                    ('Hello, %name%!', '00:00:00', '23:59:59'),
                    ('Welcome back!', '00:00:00', '23:59:59'),
                    ('Good night %name%!', '00:00:00', '04:59:59'),
                    ('Good morning %name%!', '05:00:00', '09:59:59'),
                    ('Good afternoon %name%!', '10:00:00', '17:59:59'),
                    ('Good evening %name%!', '18:00:00', '23:59:59')
            ");
        }
    }
};
```

> ‚òùÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**<br>
> –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤ –±–æ–µ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ –º—ã –Ω–µ –¥–µ–ª–∞–µ–º —ç—Ç–æ –≤—Ä—É—á–Ω—É—é, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —Å–æ–∑–¥–∞—é—â–∏–π —Ñ–∞–π–ª—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏.


## –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å —Ñ–∞–π–ª–∞–º–∏ —Ñ–∏—á–∏

–ú—ã –Ω–µ —Å–º–µ—à–∏–≤–∞–µ–º –≤–µ—Å—å –∫–æ–¥ –≤ –æ–¥–Ω—É –∫—É—á—É, –∏ —Å—Ç–∞—Ä–∞–µ–º—Å—è –∞–∫–∫—É—Ä–∞—Ç–Ω–æ —Ä–∞—Å–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ñ–∏—á–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–∞–ø–æ—á–∫–∞–º.

–ü–æ—ç—Ç–æ–º—É –¥–ª—è –Ω–∞—à–µ–π –Ω–æ–≤–æ–π —Ñ–∏—á–∏ —Å–æ–∑–¥–∞–¥–∏–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é [library/Dostavista/Features/CourierGreetings](https://github.com/27cm/backend-code-sample/tree/master/library/Dostavista/Features/CourierGreetings).

–í—Å–µ –∫–ª–∞—Å—Å—ã –∏ —Ñ–∞–π–ª—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —ç—Ç–æ–π —Ñ–∏—á–µ, –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.


## –ö–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π

–ß—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–∞ –∫–ª–∞—Å—Å–∞: `CourierGreetingRow` –∏ `CourierGreetingsTable`.

**[library/Dostavista/Features/CourierGreetings/CourierGreetingsTable.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierGreetings/CourierGreetingsTable.php)**

```php
<?php

namespace Dostavista\Features\CourierGreetings;

use Dostavista\Framework\Database\TableAbstract;

/**
 * –¢–∞–±–ª–∏—Ü–∞ —Å –ª–∏—á–Ω—ã–º–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
 *
 * @method static CourierGreetingRow|null getRow(array $where = [], string[] $order = [], int|null $offset = null)
 * @method static CourierGreetingRow|null getRowById(int|null $id)
 * @method static CourierGreetingRow|null getRowFromSql(string $sql, array $params = [])
 * @method static CourierGreetingRow|null getRowByForeignKey(string $fieldName, int $foreignKeyId)
 * @method static CourierGreetingRow requireRowById(int $id, string|null $errorMessage = null)
 * @method static CourierGreetingRow getOrCreateRowById(int $id)
 * @method static CourierGreetingRow getOrMakeUnsavedRowById(int $id)
 * @method static CourierGreetingRow makeUnsavedRow()
 * @method static CourierGreetingRow createFromArray(array $data = [])
 * @method static CourierGreetingRow[] getRowset(array $where = [], string[] $order = [], int|null $count = null, int|null $offset = null)
 * @method static CourierGreetingRow[] getRowsetByIds(int[] $ids, string[] $order = [], int|null $count = null, int|null $offset = null)
 * @method static CourierGreetingRow[] getRowsetFromSql(string $sql, array $params = [])
 * @method static CourierGreetingRow[] getRowsetByForeignKeys(string $fieldName, int[] $foreignKeyIds)
 * @method static CourierGreetingRow[] warmupGetRowByIdCache(int[] $ids)
 * @method static CourierGreetingRow[] warmupGetRowsetByForeignKeysCache(string $fieldName, int[] $foreignKeyIds)
 */
class CourierGreetingsTable extends TableAbstract {
    public static function getTableName(): string {
        return 'courier_greetings';
    }

    public static function getRowClass(): string {
        return CourierGreetingRow::class;
    }
}
```

**[library/Dostavista/Features/CourierGreetings/CourierGreetingRow.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierGreetings/CourierGreetingRow.php)**

```php
<?php

namespace Dostavista\Features\CourierGreetings;

use Dostavista\Core\Changelogs\ChangelogTable;
use Dostavista\Framework\Database\TableRowAbstract;

/**
 * –õ–∏—á–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∫—É—Ä—å–µ—Ä–æ–≤ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.
 *
 * @property int    $courier_greeting_id         –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∫—É—Ä—å–µ—Ä–∞.
 * @property string $greeting_template           –®–∞–±–ª–æ–Ω —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
 * @property string $allowed_to_show_start_time  –î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
 * @property string $allowed_to_show_finish_time –î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
 */
class CourierGreetingRow extends TableRowAbstract {
}
```


–¢–µ–ø–µ—Ä—å –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –∫–æ–¥–∞ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã.
–ù–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞ `CourierGreetingsTable::getRowById(1)` –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å ID = 1.

> ‚òùÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**<br>
> –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤ –±–æ–µ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ —É –Ω–∞—Å –µ—Å—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —Å–æ–∑–¥–∞—é—â–∏–π –≤—Å–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.


## CRUD –≤ –∞–¥–º–∏–Ω–∫–µ

–°–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π [CRUD](https://ru.wikipedia.org/wiki/CRUD) –≤ –∞–¥–º–∏–Ω–∫–µ,
—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª—è—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π.
–î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ä–º—É –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.

–°–æ–∑–¥–∞–¥–∏–º —Ñ–æ—Ä–º—É:

**[library/Dostavista/Features/CourierGreetings/CourierGreetingForm.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierGreetings/CourierGreetingForm.php)**

```php
<?php

namespace Dostavista\Features\CourierGreetings;

// ...

class CourierGreetingForm extends FormAbstract {
    public function init(): void {
        parent::init();

        // –®–∞–±–ª–æ–Ω —Å —Ç–µ–∫—Å—Ç–æ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        $this->addText('greeting_template', [
            'label'       => 'Greeting template',
            'description' => 'Variable %name% is allowed. Example: Hello, %name%!',
            'required'    => true,
            'maxlength'   => 1024,
            'filters'     => [
                new StringTrimFilter(),
                new StripTagsFilter(),
            ],
            'validators' => [new StringLengthValidator(1, 1024)],
        ]);

        // –î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        $this->addText('allowed_to_show_start_time', [
            'label'      => 'Allowed to show interval start time',
            'value'      => '00:00:00',
            'class'      => 'js-input-time',
            'required'   => true,
            'filters'    => [new DateTimeFilter(null, 'H:i')],
            'validators' => [new TimeValidator()],
        ]);

        // –î–æ–ø—É—Å—Ç–∏–º–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        $this->addText('allowed_to_show_finish_time', [
            'label'      => 'Allowed to show interval finish time',
            'value'      => '23:59:59',
            'class'      => 'js-input-time',
            'required'   => true,
            'filters'    => [new DateTimeFilter(null, 'H:i')],
            'validators' => [new TimeValidator()],
        ]);

        $this->addSubmit('Save');
    }

    public function setCourierGreetingData(CourierGreetingRow $greeting): void {
        $values = $this->getValuesMapped();

        $greeting->greeting_template           = $values['greeting_template'];
        $greeting->allowed_to_show_start_time  = $values['allowed_to_show_start_time'];
        $greeting->allowed_to_show_finish_time = $values['allowed_to_show_finish_time'];
    }
}
```

–§–æ—Ä–º–∞ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è. –í–æ—Ç —Ç–∞–∫ —ç—Ç–æ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ:

![](.github/form.png)

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∏ —Ä–∞–∑—Ä–µ—à–∏–º –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Å –ø—Ä–∞–≤–∞–º–∏ `Permissions::PERM_GROUP_CONTENT_MANAGER`:

**[library/Dostavista/Features/CourierGreetings/CourierGreetingsDispatcherController.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierGreetings/CourierGreetingsDispatcherController.php)**

```php
<?php

namespace Dostavista\Features\CourierGreetings;

// ...

/**
 * –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è–º–∏ –∫—É—Ä—å–µ—Ä–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ.
 */
class CourierGreetingsDispatcherController extends DispatcherControllerAbstract {
    public static function isActionPermitted(string $action, ?EmployeeRow $user = null): bool {
        return Permissions::hasAccess(Permissions::PERM_GROUP_CONTENT_MANAGER, $user);
    }

    /**
     * –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∫—É—Ä—å–µ—Ä–æ–≤.
     */
    public function indexAction(): CourierGreetingsIndexView {
        $view = new CourierGreetingsIndexView();

        $view->greetings = CourierGreetingsTable::getRowset(['is_deleted = 0'], ['courier_greeting_id']);

        return $view;
    }

    /**
     * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤.
     */
    public function addAction(): ViewAbstract {
        $form = new CourierGreetingForm();

        if ($this->getRequest()->isPost() && $form->isValid($this->getRequest()->getPost())) {
            $greeting = CourierGreetingsTable::makeUnsavedRow();
            $form->setCourierGreetingData($greeting);
            $greeting->save();

            FlashMessagesTable::addFlashMessage("New courier greeting #{$greeting->courier_greeting_id} was created");
            return RedirectView::createInternalRedirect('/dispatcher/courier-greetings');
        }

        $view = new CourierGreetingsAddView();

        $view->form = $form;

        return $view;
    }

    /**
     * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤.
     */
    public function editAction(): ViewAbstract {
        $greetingId = (int) $this->getRequest()->getParam('id');

        $greeting = CourierGreetingsTable::getRowById($greetingId);
        if (!$greeting) {
            FlashMessagesTable::addFlashMessage("Error! Courier greeting #{$greetingId} not found");
            return RedirectView::createInternalRedirect($this->getRequest()->getReferer(), '/dispatcher/courier-greetings');
        }

        $form = new CourierGreetingForm();
        $form->setDefaults($greeting->toArray());

        if ($this->getRequest()->isPost() && $form->isValid($this->getRequest()->getPost())) {
            $form->setCourierGreetingData($greeting);
            $greeting->save();

            FlashMessagesTable::addFlashMessage("Courier greeting #{$greetingId} was changed");
            return RedirectView::createInternalRedirect('/dispatcher/courier-greetings');
        }

        $view = new CourierGreetingsEditView();

        $view->greeting = $greeting;
        $view->form     = $form;

        return $view;
    }

    /**
     * –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤.
     */
    public function deleteAction(): ViewAbstract {
        $this->requirePost();

        $greetingId = (int) $this->getRequest()->getParam('id');

        $greeting = CourierGreetingsTable::getRowById($greetingId);
        if (!$greeting) {
            FlashMessagesTable::addFlashMessage("Error! Courier greeting #{$greetingId} not found");
            return RedirectView::createInternalRedirect($this->getRequest()->getReferer(), '/dispatcher/courier-greetings');
        }

        $greeting->is_deleted = true;
        $greeting->save();

        FlashMessagesTable::addFlashMessage("Courier greeting #{$greetingId} was deleted");
        return RedirectView::createInternalRedirect($this->getRequest()->getReferer(), '/dispatcher/courier-greetings');
    }
}
```

–ü–æ–ª—É—á–∏–º –≤–æ—Ç —Ç–∞–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –∞–¥–º–∏–Ω–∫–µ:

![](.github/index.png)

> ‚òùÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**<br>
> –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤ –±–æ–µ–≤–æ–º –ø—Ä–æ–µ–∫—Ç–µ —É –Ω–∞—Å –µ—Å—Ç—å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, —Å–æ–∑–¥–∞—é—â–∏–π –≤—Å–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.


## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

–°–∞–º–æ–µ –≤—Ä–µ–º—è –æ–ø–∏—Å–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –Ω–∞—à–µ–π –Ω–æ–≤–æ–π —Ñ–∏—á–∏. –¢–∞–∫ –∫–∞–∫ —Ç—É—Ç —É –Ω–∞—Å –ª–æ–≥–∏–∫–∞ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è,
—Ç–æ —Å–æ–∑–¥–∞–¥–∏–º –º–µ—Ç–æ–¥ –ø—Ä—è–º–æ –≤ –∫–ª–∞—Å—Å–µ `CourierGreetingsTable`. –ú—ã —á–∞—Å—Ç–æ —Ç–∞–∫ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –Ω–∞ –≤—ã—Ä–æ—Å—Ç.
–ö–æ–≥–¥–∞ –ª–æ–≥–∏–∫–∞ —Å—Ç–∞–Ω–µ—Ç —Å–∏–ª—å–Ω–æ —Å–ª–æ–∂–Ω–µ–µ, —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –º—ã –≤—ã–¥–µ–ª—è–µ–º –µ—ë –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å `CourierGreetingManager`.

–¢–∞–∫–∂–µ –Ω–µ –∑–∞–±—ã–≤–∞–µ–º, —á—Ç–æ –Ω–∞—à–∏ –∫—É—Ä—å–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö, –ø–æ—ç—Ç–æ–º—É –≤—ã—á–∏—Å–ª—è–µ–º –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Ä–µ–≥–∏–æ–Ω–µ –∫—É—Ä—å–µ—Ä–∞.

**[library/Dostavista/Features/CourierGreetings/CourierGreetingsTable.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierGreetings/CourierGreetingsTable.php)**

```php
<?php

namespace Dostavista\Features\CourierGreetings;

// ...

class CourierGreetingsTable extends TableAbstract {
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–∞.
     */
    public static function getRandomGreetingMessage(CourierRow $courier): ?string {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Ä–µ–≥–∏–æ–Ω–µ –∫—É—Ä—å–µ—Ä–∞
        $region    = $courier->getRegion();
        $localTime = $region->getLocalDateTime();

        // –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        $greetings = [];
        foreach (static::getRowset(['is_deleted = 0']) as $greeting) {
            $startTime  = $region->getLocalDateTime($greeting->allowed_to_show_start_time);
            $finishTime = $region->getLocalDateTime($greeting->allowed_to_show_finish_time);
            if ($startTime <= $localTime && $localTime <= $finishTime) {
                $greetings[] = $greeting;
            }
        }

        if (empty($greetings)) {
            return null;
        }

        // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è –∫—É—Ä—å–µ—Ä–∞ –≤ —à–∞–±–ª–æ–Ω
        $greeting = $greetings[array_rand($greetings)];
        return str_ireplace('%name%', $courier->user_name, $greeting->greeting_template);
    }
}
```


## API

–ß—Ç–æ–±—ã –º–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–º–æ–≥–ª–∏ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ Courier API:

**[library/Dostavista/Features/CourierApi/CourierApiController.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierApi/CourierApiController.php#L251-L263)**

```php
<?php

namespace Dostavista\Features\CourierApi;

// ...

class CourierApiController extends ModernApiControllerAbstract {
    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞.
     */
    public function randomGreetingAction(): JsonView {
        $this->requireGet();
        $courier = $this->requireAuthCourier();

        $greetingText = CourierGreetingsTable::getRandomGreetingMessage($courier);

        return $this->makeResponse([
            'greeting_text' => TypeCaster::stringOrNull($greetingText),
        ]);
    }
    
    // ...
}
```

–¢–µ–ø–µ—Ä—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–º–æ–≥—É—Ç –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —ç—Ç–æ–º—É –º–µ—Ç–æ–¥—É —Å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Å—Å–∏–µ–π –∫—É—Ä—å–µ—Ä–∞ –∏ –ø–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.

> ‚òùÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**<br>
> –£ –Ω–∞—Å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –µ—Å—Ç—å API Design Guidelines, –∫–æ—Ç–æ—Ä—ã–º –º—ã —Å–ª–µ–¥—É–µ–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ API.


## API Schema

–ß—Ç–æ–±—ã —É –º–æ–±–∏–ª—å–Ω—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –±—ã–ª–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, –¥–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ —Å—Ö–µ–º—É API.
–î–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª:

**[library/Dostavista/Features/CourierApi/api-schema/methods/random-greeting.php](https://github.com/27cm/backend-code-sample/blob/master/library/Dostavista/Features/CourierApi/api-schema/methods/random-greeting.php)**

```php
<?php

use Dostavista\Features\CourierApi\CourierApiController;
use Dostavista\Framework\ApiSchema\ApiDoc;

return [
    'title'       => '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
    'description' => '–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞',

    /** @see CourierApiController::randomGreetingAction() */
    'path'          => '/random-greeting',
    'http_method'   => ApiDoc::GET,
    'auth_required' => true,

    'parameters' => [],

    'response' => [
        'properties' => [
            'greeting_text' => [
                'description' => '–¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è',
                'type'        => ApiDoc::STRING,
                'nullable'    => true,
                'example'     => '–ü—Ä–∏–≤–µ—Ç, –ò–≥–æ—Ä—å!',
            ],
        ],
    ],
];
```

–¢–µ–ø–µ—Ä—å –≤ –∫—É—Ä—å–µ—Ä—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è [–Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞](https://raw.githubusercontent.com/27cm/backend-code-sample/master/.github/api-doc.png) —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –º–µ—Ç–æ–¥–∞ API.


## –¢–µ—Å—Ç—ã

–ß—Ç–æ–±—ã –∏–∑ —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–∑—ã–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ Courier API, –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ `CourierApiHelper`.

**[tests/Dostavista/TestUtils/Api/CourierApiHelper.php](https://github.com/27cm/backend-code-sample/blob/master/tests/Dostavista/TestUtils/Api/CourierApiHelper.php#L54-L66)**

```php
<?php

namespace Dostavista\TestUtils\Api;

// ...

class CourierApiHelper {
    /**
     * @see CourierApiController::randomGreetingAction()
     */
    public function getRandomGreeting(?CourierRow $courier = null): ModernApiClient {
        return $this->buildGetRequest('random-greeting', $courier);
    }
}
```

–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–µ–º –ø–∞—Ä—É —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ Courier API. –°–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å `CourierApiRandomGreetingTest`.

**[tests/Dostavista/Tests/CourierApi/CourierApiRandomGreetingTest.php](https://github.com/27cm/backend-code-sample/blob/master/tests/Dostavista/Tests/CourierApi/CourierApiRandomGreetingTest.php)**

```php
<?php

namespace Dostavista\Tests\CourierApi;

use Dostavista\Features\CourierApi\CourierApiController;
use Dostavista\Features\CourierGreetings\CourierGreetingsTable;
use Dostavista\Tests\TestCaseAbstract;

/**
 * –¢–µ—Å—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –∫—É—Ä—å–µ—Ä–∞.
 * @covers CourierApiController::randomGreetingAction()
 */
class CourierApiRandomGreetingTest extends TestCaseAbstract {
    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ –≤ –±–∞–∑–µ –Ω–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è –∫—É—Ä—å–µ—Ä–∞.
     * @covers CourierApiController::randomGreetingAction()
     */
    public function testRandomGreetingEmpty(): void {
        $courier = $this->getCourierProvider()->getApprovedCourier();

        $json = $this->getCourierApiHelper()->getRandomGreeting($courier)->getJson();
        assertNull($json['greeting_text']);
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –¥–ª—è –∫—É—Ä—å–µ—Ä–∞.
     * @covers CourierApiController::randomGreetingAction()
     */
    public function testRandomGreetingSimple(): void {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
        $greeting = CourierGreetingsTable::makeUnsavedRow();

        $greeting->greeting_template = '–ü—Ä–∏–≤–µ—Ç, %name%!';
        $greeting->save();

        $courier = $this->getCourierProvider()->getApprovedCourier();

        $json = $this->getCourierApiHelper()->getRandomGreeting($courier)->getJson();
        assertSame('–ü—Ä–∏–≤–µ—Ç, –ö—É—Ä—å–µ—Ä!', $json['greeting_text']);
    }
}
```

> ‚òùÔ∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**<br>
> –£ –Ω–∞—Å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –µ—Å—Ç—å Coding Guidelines, –∫–æ—Ç–æ—Ä—ã–º –º—ã —Å–ª–µ–¥—É–µ–º, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å —Ö–æ—Ä–æ—à–∏–µ —Ç–µ—Å—Ç—ã.

–í–æ—Ç –∏ –≤—Å—ë.
<br>–û—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ø—É—à–∏—Ç—å –≤–µ—Ç–∫—É, —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤ Teamcity –ø—Ä–æ–π–¥—É—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã, –∏ —Å–æ–∑–¥–∞—Ç—å –ø—É–ª–ª-—Ä–∏–∫–≤–µ—Å—Ç.
<br>–ò –≤—Å–∫–æ—Ä–µ —Ñ–∏—á–∞ –ø–æ–ø–∞–¥—ë—Ç –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω.
